# Chrome Extension Source Code Index
**Path**: `3.0 Build/3.1 Chrome/3.1.5 Chrome Build/src/`

## Directory Structure

```
src/
├── assets/icons/          # Extension icons
├── background/            # Service worker scripts
├── content/               # Gmail page content scripts
├── lib/                   # Shared utilities and services
├── popup/                 # Extension popup UI
└── ui/                    # Injected UI components
```

## File Inventory by Size

### Large Files (>400 lines)
| File | Lines | Purpose | Split Needed? |
|------|-------|---------|---------------|
| `lib/qrcode.min.ts` | 2835 | QR code generation (vendor library) | ❌ No - vendor code |
| `background/index.ts` | 1942 | Main background service worker | ⚠️ Review - very large |
| `lib/public-key-registry-supabase.ts` | 719 | Supabase public key registry client | ✅ Cohesive |
| `content/InboxIndicators.ts` | 702 | Gmail inbox trust indicators | ⚠️ Review if split needed |
| `content/SidebarManager.ts` | 651 | Sidebar UI management | ✅ Cohesive |
| `content/UIInjector.ts` | 425 | Trust badge and UI injection | ✅ Cohesive |

### Medium Files (200-400 lines)
| File | Lines | Purpose |
|------|-------|---------|
| `popup/popup.ts` | 346 | Extension popup logic |
| `background/tpm-interface.ts` | 319 | TPM native messaging interface |
| `lib/dkim-canonicalization.ts` | 303 | DKIM signature canonicalization |
| `content/VerificationService.ts` | 295 | Email verification orchestrator |
| `content/verification-state-manager.ts` | 291 | Verification state management |
| `content/inbox-features.ts` | 263 | Inbox feature enhancements |
| `content/ComposeDetector.ts` | 244 | Compose window detection |

### Small Files (<200 lines)
| File | Lines | Purpose |
|------|-------|---------|
| `content/index.ts` | 200 | Content script entry point |
| `lib/utils.ts` | 199 | Utility functions (RateLimiter, Mutex, etc.) |
| `content/LifecycleManager.ts` | 184 | Event listener and observer cleanup |
| `lib/retry-with-backoff.ts` | 183 | Retry and offline queue logic |
| `lib/trust-states.ts` | 150 | Trust state definitions |
| `lib/device-qr-service.ts` | 145 | Device QR code generation |
| `lib/config.ts` | ~100 | Configuration constants |
| `lib/Logger.ts` | ~50 | Logging utility |
| `content/DomSelectors.ts` | ~80 | Gmail DOM selectors |

## Module Dependencies

### Background Scripts
- **`background/index.ts`** (1942 lines) - Main service worker
  - Imports: config, trust-states, TPMInterface, DKIMCanonicalizer, PublicKeyRegistry, utils
  - Responsibilities:
    - Gmail API integration (OAuth, message fetching, sending)
    - Email signing with TPM
    - Email verification with DKIM-style signatures
    - Public key registration in Supabase
    - Message caching and rate limiting
    - Device setup and management
  - **Concerns**: Very large file, potential split candidates:
    - Gmail API operations → separate module
    - Verification logic → separate module
    - Device management → separate module

- **`background/tpm-interface.ts`** (319 lines)
  - Native messaging bridge to TPM host
  - Methods: isAvailable(), getPublicKey(), signData()

### Content Scripts
- **`content/index.ts`** (200 lines) - Entry point
  - Initializes: GmailObserver, ComposeDetector, InboxIndicators, SidebarManager
  - Sets up message passing with background script

- **`content/GmailObserver.ts`** - Gmail DOM change observer
  - Watches for email view changes
  - Triggers verification when emails are opened

- **`content/ComposeDetector.ts`** (244 lines)
  - Detects Gmail compose windows
  - Injects "Send Signed" button
  - Handles email data extraction

- **`content/VerificationService.ts`** (295 lines)
  - Orchestrates email verification
  - Coordinates with background script
  - Manages verification UI updates

- **`content/UIInjector.ts`** (425 lines)
  - Injects trust badges and indicators
  - Displays verification modals
  - Manages visual feedback

- **`content/InboxIndicators.ts`** (702 lines)
  - Inbox list view trust indicators
  - Batch verification of threads
  - Green dots for verified emails

- **`content/SidebarManager.ts`** (651 lines)
  - Device setup sidebar
  - QR code display
  - Settings management

- **`content/LifecycleManager.ts`** (184 lines)
  - Manages event listeners and observers
  - Cleanup on Gmail navigation

- **`content/verification-state-manager.ts`** (291 lines)
  - Centralized verification state
  - Pub/sub for verification updates

### Library Modules
- **`lib/config.ts`** - Environment configuration
  - Supabase URLs and keys
  - Environment detection

- **`lib/trust-states.ts`** (150 lines)
  - Trust state definitions (verified, unknown, suspicious)
  - State determination logic

- **`lib/dkim-canonicalization.ts`** (303 lines)
  - DKIM-style email canonicalization
  - Signature preparation and verification

- **`lib/public-key-registry-supabase.ts`** (719 lines)
  - Supabase client for public key registry
  - Key registration, lookup, and caching
  - User preferences management

- **`lib/utils.ts`** (199 lines)
  - RateLimiter class (Gmail API rate limiting)
  - Mutex class (concurrency control)
  - Utility functions

- **`lib/retry-with-backoff.ts`** (183 lines)
  - Exponential backoff retry logic
  - Offline queue for network failures

- **`lib/device-qr-service.ts`** (145 lines)
  - Generates device QR codes
  - Uses qrcode.min.ts

- **`lib/Logger.ts`** - Logging abstraction
  - Console logging wrapper

- **`lib/qrcode.min.ts`** (2835 lines) - Vendor library (DO NOT MODIFY)

## Cleanup Priority by File

### High Priority (Large, Complex Files)
1. **`background/index.ts`** (1942 lines)
   - Review for:
     - Dead code (unused functions)
     - Verbose comments
     - Potential module splits
   - Consider splitting into:
     - `background/gmail-api.ts` (OAuth, fetching, sending)
     - `background/verification.ts` (signature verification)
     - `background/device-management.ts` (device setup, key registration)

2. **`content/InboxIndicators.ts`** (702 lines)
   - Review for comment bloat
   - Check for unused code

3. **`content/SidebarManager.ts`** (651 lines)
   - Review for comment bloat
   - Check for unused functions

### Medium Priority (300-400 lines)
4. **`content/UIInjector.ts`** (425 lines)
5. **`popup/popup.ts`** (346 lines)
6. **`background/tpm-interface.ts`** (319 lines)
7. **`lib/dkim-canonicalization.ts`** (303 lines)

### Low Priority (Well-sized files)
- Files under 300 lines are generally well-scoped
- Still review for comment bloat and dead code

## Common Patterns to Look For

### Across All Files
1. **Unused imports** - TypeScript may have unused import statements
2. **Commented-out code** - Old implementations left in comments
3. **Debug logging** - Excessive console.log statements
4. **Verbose comments** - Multi-line explanations that belong in git history
5. **Duplicate error handling** - Similar try/catch patterns that could be abstracted
6. **TODO comments** - Completed TODOs that should be removed

### In background/index.ts Specifically
- **Message handler bloat** - 20+ action handlers in chrome.runtime.onMessage
- **Repeated auth retry logic** - attemptNumber parameter in multiple functions
- **Cache management code** - Multiple cache Maps with similar TTL logic
- **Validation patterns** - Repeated input validation (could be abstracted)

### In Content Scripts
- **DOM selector duplication** - Similar querySelector patterns
- **Gmail API quirks comments** - Keep these, they're valuable
- **Event listener cleanup** - Already managed by LifecycleManager (good)

## Files Already Cleaned
✅ `background/index.ts` - Comment prefixes removed (MEDIUM BUG FIX, etc.)
✅ `content/ComposeDetector.ts` - Comment bloat removed
✅ `content/GmailObserver.ts` - Bug fix prefixes removed
✅ `lib/utils.ts` - SECURITY FIX prefixes removed
✅ `lib/public-key-registry-supabase.ts` - Comment prefixes removed
✅ `content/verification-state-manager.ts` - TODO: DELETE comments removed

## Recommended Cleanup Order

1. **Phase 1**: Find unused imports across all files
2. **Phase 2**: Remove commented-out code blocks
3. **Phase 3**: Review `background/index.ts` for potential split
4. **Phase 4**: Clean up content scripts (InboxIndicators, SidebarManager, UIInjector)
5. **Phase 5**: Review lib/ modules for dead code
6. **Phase 6**: Final pass for verbose comments

## Total Source Code Stats
- **Total Lines**: ~10,618
- **Files**: 24 TypeScript files
- **Average File Size**: ~442 lines
- **Largest File**: background/index.ts (1942 lines)
- **Files >400 lines**: 6 files

## Notes
- Vendor libraries (qrcode.min.ts) should not be modified
- Gmail DOM selectors are fragile - keep comments explaining Gmail's structure
- Performance-critical paths (verification, caching) - keep optimization comments
- Security-related validation - keep comments explaining attack vectors
